<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.04f3873a1f7001cb8c49.css">html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font:112.5%/1.45em georgia,serif,sans-serif;box-sizing:border-box;overflow-y:scroll}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#fff;background:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects;color:#8fbc8f;text-decoration:none}a:active,a:hover{outline-width:0;text-decoration:underline}abbr[title]{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help;text-decoration:none}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.83711rem;line-height:1.1}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none;max-width:100%;padding:0;margin:0 0 1.45rem}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace;font-size:1em}figure{padding:0;margin:0 0 1.45rem}hr{box-sizing:content-box;overflow:visible;padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;padding:0;margin:0 0 1.45rem}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}*,:after,:before{box-sizing:inherit}h2{font-size:1.5rem}h2,h3{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:400;text-rendering:optimizeLegibility;line-height:1.1}h3{font-size:1.38316rem}h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,p{padding:0;margin:0 0 1.45rem}p{font-size:.9rem;font-family:sans-serif;font-weight:300;color:silver!important}pre{font-size:.85rem;line-height:1.42;background:rgba(64,191,64,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem;border:thin solid #fff;border-radius:5px}pre,table{margin:0 0 1.45rem}table{padding:0;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}blockquote{padding:0;margin:0 1.45rem 1.45rem}address,form,iframe,noscript{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem;font-family:sans-serif}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code{font-size:.6rem;line-height:1.45rem}kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}img.thumbnail{max-width:150px;max-height:100px}img.thumbnail:after{display:block}.article-summary{display:block;border:thin solid #fff;margin:.5rem;padding:1rem}.article-summary-row{display:block;clear:both}#div-menu li{font-size:.8rem;padding-left:20px;list-style:none}.toc{border:thin solid silver;padding:1rem}.toc p{margin-bottom:.5rem}#article-body h2,#article-body h3,#article-body h4{color:#90ee90}#div-menu{margin-top:70px;width:30%;float:right}#index-btn{bottom:30px;width:40px;height:40px;background:#0ff;color:#fff;border-radius:20px;text-align:center;line-height:40px}#bottom-toc,#index-btn{position:fixed;right:30px;z-index:1}#bottom-toc{bottom:80px;background:#333}</style><meta name="generator" content="Gatsby 2.24.65"/><title data-react-helmet="true">Raspberry PiでDiscordボットを作る(2) センサの接続とボットプログラムの作成 | Proactive Cybernetics</title><meta data-react-helmet="true" name="description" content="趣味は電子工作とホームページ作りです。"/><meta data-react-helmet="true" property="og:title" content="Raspberry PiでDiscordボットを作る(2) センサの接続とボットプログラムの作成"/><meta data-react-helmet="true" property="og:description" content="趣味は電子工作とホームページ作りです。"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator"/><meta data-react-helmet="true" name="twitter:title" content="Raspberry PiでDiscordボットを作る(2) センサの接続とボットプログラムの作成"/><meta data-react-helmet="true" name="twitter:description" content="趣味は電子工作とホームページ作りです。"/><link rel="icon" href="/favicon-32x32.png?v=593b49b6b505d52ffa9b30da96a86f85" type="image/png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=593b49b6b505d52ffa9b30da96a86f85"/><link as="script" rel="preload" href="/webpack-runtime-ebe4b220d797aa410321.js"/><link as="script" rel="preload" href="/framework-29ba174b433dc5858bed.js"/><link as="script" rel="preload" href="/app-d97328ac12a82a8c5235.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/cb1608f2-f6f058bed42caceea208.js"/><link as="script" rel="preload" href="/commons-21ff20e091921c8c0225.js"/><link as="script" rel="preload" href="/component---src-templates-blog-article-js-9b1f8943374745c17eb9.js"/><link as="fetch" rel="preload" href="/page-data/article/202010-raspi-bot/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/272570591.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3000541721.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="background:#333;color:silver;height:100%;overflow:hidden;min-height:100%"><header style="background:black;margin-bottom:1.45rem"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem"><h1 style="margin:0"><a style="color:lightgray;text-decoration:none" href="/">Proactive Cybernetics</a></h1></div></header><div style="margin:0 auto;max-width:960px;padding:0 1.0875rem 1.45rem;overflow:hidden"><main style="width:100%;overflow:hidden"><div style="width:60%;float:left"><h1>Raspberry PiでDiscordボットを作る(2) センサの接続とボットプログラムの作成</h1><a name="top"></a><p><span>タグ :<a href="/tag/hardware">ハードウェア<!-- --> </a><a href="/tag/iot-device">IoTデバイス<!-- --> </a></span>  <span style="text-align:right">2020年10月7日<!-- --> by <!-- -->Oganesson</span></p><div style="margin:1rem"><div class="toc"><p><strong>目次</strong></p><p style="font-size:0.9em"><a href="#hc77b57de51">あらまし</a></p><p style="font-size:0.9em"><a href="#hfb91fd38fa">I2C環境センサについて</a></p><p style="font-size:0.9em"><a href="#h3ea3cca820">Raspberry PiでI2Cを有効化する</a></p><p style="font-size:0.9em"><a href="#h9142ef6055">Raspberry Piにセンサを接続</a></p><p style="font-size:0.9em"><a href="#h0e869fb9b5">センサの動作確認</a></p><p style="font-size:0.9em"><a href="#h37245156f0">Discordボットの作成 : 自分専用サーバーの作成とボットの登録</a></p><p style="font-size:0.8em;padding-left:20px"><a href="#h830f7115b8">Discordサーバーにボットを招待する</a></p><p style="font-size:0.9em"><a href="#h22b6b12c88">DiscordボットのためのPythonの設定</a></p><p style="font-size:0.9em"><a href="#haddfa43deb">ボットの実装</a></p><p style="font-size:0.8em;padding-left:20px"><a href="#h40ea9a7213">一定時間ごとに定期投稿する</a></p><p style="font-size:0.9em"><a href="#ha214098e44">まとめ</a></p></div></div><div id="article-body"><h2 id="hc77b57de51">あらまし</h2><p><a href="https://proactive-cybernetics.netlify.app/article/202009-raspi-os" target="_blank" rel="noopener noreferrer">前回の記事</a>でRaspberry Piにリモートログインができるようになったところから、<br>本格的にRaspberry Piらしいことをしていこうと思います。<br><br>今回は、Raspberry PiでI2C接続のセンサから測定値を読み取る方法と、<br>センサから読み取った測定値をチャットサービス(<a href="https://discord.com/" target="_blank" rel="noopener noreferrer">Discord</a>)に投稿するボットを作る方法を説明します。<br></p><h2 id="hfb91fd38fa">I2C環境センサについて</h2><p>I2Cとは、<a href="https://ja.wikipedia.org/wiki/I2C" target="_blank" rel="noopener noreferrer">Wikipediaの記事</a>にあるように1つのコントローラ(マイコンなど)と、1個または多数の周辺機器を接続する<br>シリアル式のバス接続規格です。<br>I2Cは「アイ・スクェアド・シー」または「アイ・トゥ・シー」と読まれることが多いです。<br><br>今回使うI2C接続のセンサとして、<a href="https://akizukidenshi.com/catalog/g/gK-14469/" target="_blank" rel="noopener noreferrer">Boshe BME680環境センサ</a>を購入しました。<br>このセンサでは温度と湿度、気圧の測定が行えます。<br><br>秋月電子の通販で買ったものではセンサ素子の乗った基板とブレッドボードに挿せるピンヘッダが付属していましたが、<br>自分でピンヘッダを基板にはんだ付けする必要がありました。<br>(はんだ付けの技術については、本記事では割愛します。)<br></p><h2 id="h3ea3cca820">Raspberry PiでI2Cを有効化する</h2><p>Raspberry PiのI2Cはデフォルトで無効になっていますので、有効化の設定を行います。<br><br>まず、aptパッケージマネージャでi2c-toolsパッケージをインストールします。</p><pre><code>sudo apt install i2c-tools</code></pre><p><br>次に、raspi-configツールからi2cの設定を有効にします。</p><pre><code>sudo raspi-config</code></pre><p><br>raspi-configのメニュー画面から、矢印キーで「5 Interfacing Options」を選択してEnterキーを押します。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-07%2021.52.31.png" alt><br><br>Interfacing Optionsのメニューに入るので、「P5 I2C」を選択してEnterキーを押します。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-07%2021.55.15.png" alt><br><br>「はい」を選択します。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-07%2021.55.57.png" alt><br><br>I2Cが有効化された旨が表示されます。raspi-configのメニューから「Finish」でメニューを閉じて次に進みます。<br></p><h2 id="h9142ef6055">Raspberry Piにセンサを接続</h2><p><br>まず、Raspberry Piの電源を切ります。</p><pre><code>sudo shutdown -h now</code></pre><p>コマンドを実行し、しばらくしたら電源用USBケーブルをRaspberry Pi本体から引き抜きます。<br><br>Raspberry Piのピンヘッダに、環境センサの各端子をジャンパワイヤで接続します。<br><br>Raspberry Pi    環境センサ<br>+5V (2)         ---        VIN (1)　(※ カッコ内はピン番号)<br>SCL (5)         ---        SCL (2)<br>SDA (3)         ---        SDA (3)<br>GND (6)         ---        GND (4)<br><br>接続ができたら、Raspberry Piに電源用USBを挿入して起動します。<br>Raspberry Piが起動したら、PCからSSHでRaspberry Piにログインします。<br></p><h2 id="h0e869fb9b5">センサの動作確認</h2><p>再起動とログインができたら、i2cdetectコマンドを実行します。<br>以下のように「77」(BME680のI2Cアドレス) が表示されればセンサが接続できています。</p><pre><code>$ sudo i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- 77</code></pre><p><br>続いて、Pythonプログラムからセンサの値を読み取ってみましょう。<br></p><pre><code>git clone https:&#x2F;&#x2F;github.com&#x2F;pimoroni&#x2F;bme680-python.git
cd bme680-python&#x2F;examples
sudo pip3 install bme680
python3 read-all.py</code></pre><p><br>以下のようにセンサから取得した値が表示されれば成功です。<br>(出力は一例です。数値はセンサの物理的環境によって異なります。)</p><pre><code>$ python3 read-all.py 
read-all.py - Displays temperature, pressure, humidity, and gas.

Press Ctrl+C to exit!

(中略)

Polling:
25.25 C,1014.70 hPa,70.11 %RH
25.26 C,1014.71 hPa,70.07 %RH,3712.5851520667234 Ohms
25.30 C,1014.73 hPa,70.00 %RH,6040.203089121114 Ohms
25.33 C,1014.71 hPa,69.91 %RH,8579.990372223523 Ohms
25.37 C,1014.70 hPa,69.83 %RH,11141.141109863216 Ohms</code></pre><p><br>キー割り込み(Ctrl-c)操作でスクリプトの実行を停止します。<br><br>ここまで出来たら、いよいよI2Cセンサの測定値をつぶやくDiscordボットの作成に入ります。<br></p><h2 id="h37245156f0">Discordボットの作成 : 自分専用サーバーの作成とボットの登録</h2><p>Discordボットを動かすための、自分専用のサーバーを作ります。<br><br>まず、Discordアプリを開いて「サーバーを追加」を選択します。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-06%2022.15.09.png" alt><br><br>「サーバーを作成」画面で「Create my own」を選びます。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-06%2022.16.53.png" alt><br><br><br>サーバー名を入力し、「新規作成」を押します。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-06%2022.18.17.png" alt><br></p><h3 id="h830f7115b8">Discordサーバーにボットを招待する</h3><p>あとは、新しく作ったサーバーにボットを招待します。<br><a href="https://discordpy.readthedocs.io/ja/latest/discord.html" target="_blank" rel="noopener noreferrer">discord.pyの公式サイト</a>にボットのアカウント作成方法がありますので、ページに示された手順に従って<br>ボットのOAuth設定と、ボットのサーバーに対する権限の設定を行います。<br>権限を適切に設定しないと、ボットがサーバーに投稿しない、もしくはボットがユーザーの投稿に反応できないことがありますので注意しましょう。<br><br>Discordのサイトの、ボットの設定ページ内にあるボットのトークンを控えておきます。<br><br>また、ボットが投稿するためのチャンネルを作成し、作成したチャンネルのIDを控えておきます。<br>チャンネルのIDは<a href="https://support.discord.com/hc/ja/articles/206346498-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC-%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8ID%E3%81%AF%E3%81%A9%E3%81%93%E3%81%A7%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B-" target="_blank" rel="noopener noreferrer">こちら</a>に記された手順で確認できます。<br></p><h2 id="h22b6b12c88">DiscordボットのためのPythonの設定</h2><p>venvによるPythonの仮想環境を作成し、その中でPIPパッケージのインストールを行います。<br>まず、作業用ディレクトリを作成します。</p><pre><code>mkdir ~&#x2F;work&#x2F;discordbot
cd ~&#x2F;work&#x2F;discordbot</code></pre><p><br>作業用ディレクトリに入ったら、venvコマンドでPythonの仮想環境を作ります。</p><pre><code>python3 -m venv .
source bin&#x2F;activate</code></pre><p><br>activateスクリプトを呼び出すとプロンプトの形が変わります。<br>この状態で、pipコマンドでパッケージを導入します。<br>導入するパッケージはbme680 (I2C環境センサの制御)と、discord.py (Discordボット用ライブラリ)です。</p><pre><code>pip install bme６８０
pip　install discord.py</code></pre><p><br>「.env」隠しファイルを作成し、その中にボットのトークンと投稿先チャネルのIDを含めます。</p><pre><code>touch .env
echo BOT_TOKEN=*********************** &gt;&gt; .env
echo SANDBOX_CHANNEL_ID=******** &gt;&gt; .env</code></pre><p><br>.envファイルはくれぐれもリポジトリにコミットしないようにしましょう。<br>Gitを使っていれば、.gitignoreファイルに「.env」を追加します。</p><pre><code>echo .env &gt;&gt; .gitignore</code></pre><p><br></p><h2 id="haddfa43deb">ボットの実装</h2><p>ボットをPythonプログラム (example_bot.py)で実装します。</p><pre><code>import discord
from discord.ext import tasks
import bme680tph
	
# 環境設定 (.env　ファイル) 用
import os
from os.path import join, dirname
from dotenv import load_dotenv
	
@client.event
async def on_ready():
    print (&#x27;We have logged in as {0.user}&#x27;.format(client))
    await client.get_channel(sandbox_channel_id).send(&#x27;こんにちは&#x27;)

@client.event
async def on_message(message):
    print(&#x27;on_message:{0}&#x27;.format(message.content));
    if message.author.bot:
        return
    if message.content.startswith(&#x27;$hello&#x27;):
        await message.channel.send(&#x27;よぅ!&#x27;)
    if message.content.startswith(&#x27;$室温&#x27;):
        await message.channel.send(bme680tph.get_sensor())

if __name__ == &quot;__main__&quot;:
　　　　load_dotenv(verbose=True)
　　　　sandbox_channel_id = int(os.environ.get(&quot;SANDBOX_CHANNEL_ID&quot;))
　　　　bot_token = os.environ.get(&quot;BOT_TOKEN&quot;)

　　　　client = discord.Client()
    client.run(bot_token)</code></pre><p><br>見ての通り、プログラムは、「@client.event」デコレータがつけられた2つの関数と<br>「if __name__==&quot;__main__&quot;:」ブロックからなります。<br><br>on_ready関数はdiscord.pyで作成したclient(ボット)がDiscordサーバーに正常に接続できた時に呼び出され、<br>on_message関数はclientが接続しているサーバーに誰かが投稿した時に呼び出されるコールバック関数です。<br><br>「if __name__==&quot;__main__&quot;:」直後の3行は.envファイルから設定(投稿先のチャンネルIDとボットのトークン)<br>を読み出す処理です。<br>最後の2行でclientを作成し、ボットの動作を開始しています。<br><br><br>センサーから気温、湿度と気圧を取得する手続きを記した<br>bme680tph.py ファイルを作成し、example_bot.pyと同じディレクトリに置きます。<br>このbme680tph.pyはpimoroni氏の提供によるライブラリ(<a href="https://pypi.org/project/bme680/" target="_blank" rel="noopener noreferrer">PyPI bme680モジュール</a>) を使用して作成しています。<br></p><pre><code>import bme680

try:
    sensor = bme680.BME680(bme680.I2C_ADDR_PRIMARY)
except IOError:
    sensor = bme680.BME680(bme680.I2C_ADDR_SECONDARY)
	

# These oversampling settings can be tweaked to
# change the balance between accuracy and noise in
# the data.	

sensor.set_humidity_oversample(bme680.OS_2X)
sensor.set_pressure_oversample(bme680.OS_4X)
sensor.set_temperature_oversample(bme680.OS_8X)
sensor.set_filter(bme680.FILTER_SIZE_3)
	

def get_sensor():
    if sensor.get_sensor_data():
        output = &quot;&quot;&quot;温度 : {0:.2f} [°C],
気圧 : {1:.2f} [hPa],
湿度 : {2:.3f} [%RH]&quot;&quot;&quot;.format(
            sensor.data.temperature,
            sensor.data.pressure,
            sensor.data.humidity)
        return(output)</code></pre><p><br>このプログラムを実行し、Discordアプリからボットの投稿用チャネルを開いて<br>「こんにちは」と投稿されていることを確認します。</p><pre><code>python3 example_bot.py</code></pre><p><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-06%2022.48.04.png" alt><br><br>また、「$hello」と投稿して、ボットが「よぅ!」と返事すること、<br>「$室温」を投稿して、ボットが気温と湿度、気圧を応答することを確認します。<br>もしボットによる投稿が確認できなかったら、ボットを起動したターミナルにエラー出力がないか確認します。<br>(なお私はon_message関数のスペルを1文字間違えたためにボットが応答せず、数時間もの間苦悶の表情を浮かべて「どおしてだよおぉぉ」と唸っていました。)<br><br>動作確認ができたら一回ボットを停止します。ボットはキーボード割り込み(Ctrl-c)で停止します。<br></p><h3 id="h40ea9a7213">一定時間ごとに定期投稿する</h3><p><br>次に、ボットに手続きを追加して、1時間ごとに気温と湿度、気圧を投稿するようにします。<br>example_bot.pyに新しく関数loopを追加します。<br></p><pre><code>@tasks.loop(seconds=60)
async def loop():
    # 現在の時刻 : 00分のときのみセンサの値を送信
　   print(datetime.now().strftime(&#x27;%H:%M&#x27;))
    if datetime.now().strftime(&#x27;%M&#x27;) == &#x27;00&#x27;:
        await client.get_channel(sandbox_channel_id).send(&#x27;定期送信\n&#x27;+bme680tph.get_sensor())</code></pre><p><br>関数loopに付けられたtasks.loopデコレータは、loop関数を一定時間ごとに実行するために付けています。<br>毎時00分に、bme680tph.pyの関数を呼び出して気温と湿度、気圧を投稿します。<br><br>続いて、clientの開始直後にloop関数の周期実行を開始させます。<br>example_bot.pyの末尾にloop.start()を追加します。</p><pre><code>    client = discord.Client()
    client.run(bot_token)
    loop.start()</code></pre><p><br>定期実行が正しく行われれば、1時間ごとに「定期送信」で始まる投稿がされるようになります。<br><img src="https://images.microcms-assets.io/protected/ap-northeast-1:9e5272dd-7b4e-43ed-93af-2c67006519ff/service/og-blog/media/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202020-10-07%2022.10.16.png" alt><br></p><h2 id="ha214098e44">まとめ</h2><p><a href="https://proactive-cybernetics.netlify.app/article/202009-raspi-os" target="_blank" rel="noopener noreferrer">第1回</a>と本記事で、以下の内容を取り上げました。<br><br>第1回</p><ul><li>Raspberry Pi OSについて<ul><li>Raspberry Pi OSイメージのダウンロードと検証</li><li>Raspberry Pi OSイメージのmicroSDへの書き込み</li><li>Raspberry Piの起動</li></ul></li><li>Raspberry Piのネットワークログイン設定<ul><li>マルチキャストDNSの導入</li><li>SSHの有効化</li></ul></li></ul><p><br>第2回</p><ul><li>I2C接続のセンサについて</li><li>I2C接続のセンサをPythonプログラムから使う</li><li>Discord.pyによるボットの作成<ul><li>ボットが定期投稿を行うようにする</li></ul></li><li>Discordサーバーの新規作成とボットの招待</li></ul><p><br>次回はやるかどうか未定ですが、出来たらHeroku上のカスタムサーバに<br>センサの測定値を定期的に送信して、気温・湿度と気圧のグラフをWebブラウザから確認できるようにしたい<br>などと考えております。<br></p></div><div style="display:inline-block"><button aria-label="facebook" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="30" height="30"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button> <button aria-label="line" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="30" height="30"><circle cx="32" cy="32" r="31" fill="#00b800"></circle><path d="M52.62 30.138c0 3.693-1.432 7.019-4.42 10.296h.001c-4.326 4.979-14 11.044-16.201 11.972-2.2.927-1.876-.591-1.786-1.112l.294-1.765c.069-.527.142-1.343-.066-1.865-.232-.574-1.146-.872-1.817-1.016-9.909-1.31-17.245-8.238-17.245-16.51 0-9.226 9.251-16.733 20.62-16.733 11.37 0 20.62 7.507 20.62 16.733zM27.81 25.68h-1.446a.402.402 0 0 0-.402.401v8.985c0 .221.18.4.402.4h1.446a.401.401 0 0 0 .402-.4v-8.985a.402.402 0 0 0-.402-.401zm9.956 0H36.32a.402.402 0 0 0-.402.401v5.338L31.8 25.858a.39.39 0 0 0-.031-.04l-.002-.003-.024-.025-.008-.007a.313.313 0 0 0-.032-.026.255.255 0 0 1-.021-.014l-.012-.007-.021-.012-.013-.006-.023-.01-.013-.005-.024-.008-.014-.003-.023-.005-.017-.002-.021-.003-.021-.002h-1.46a.402.402 0 0 0-.402.401v8.985c0 .221.18.4.402.4h1.446a.401.401 0 0 0 .402-.4v-5.337l4.123 5.568c.028.04.063.072.101.099l.004.003a.236.236 0 0 0 .025.015l.012.006.019.01a.154.154 0 0 1 .019.008l.012.004.028.01.005.001a.442.442 0 0 0 .104.013h1.446a.4.4 0 0 0 .401-.4v-8.985a.402.402 0 0 0-.401-.401zm-13.442 7.537h-3.93v-7.136a.401.401 0 0 0-.401-.401h-1.447a.4.4 0 0 0-.401.401v8.984a.392.392 0 0 0 .123.29c.072.068.17.111.278.111h5.778a.4.4 0 0 0 .401-.401v-1.447a.401.401 0 0 0-.401-.401zm21.429-5.287c.222 0 .401-.18.401-.402v-1.446a.401.401 0 0 0-.401-.402h-5.778a.398.398 0 0 0-.279.113l-.005.004-.006.008a.397.397 0 0 0-.111.276v8.984c0 .108.043.206.112.278l.005.006a.401.401 0 0 0 .284.117h5.778a.4.4 0 0 0 .401-.401v-1.447a.401.401 0 0 0-.401-.401h-3.93v-1.519h3.93c.222 0 .401-.18.401-.402V29.85a.401.401 0 0 0-.401-.402h-3.93V27.93h3.93z" fill="white"></path></svg></button> <button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="30" height="30" title="Raspberry PiでDiscordボットを作る(2) センサの接続とボットプログラムの作成"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button> <button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="30" height="30"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button></div><p style="font-size:0.8rem;padding-top:0.5rem"><a href="#top">↑先頭に戻る</a></p></div><div id="div-menu" style="width:30%;float:right"><h3>タグ</h3><li><a href="/tag/environment">環境構築</a> <!-- -->(<!-- -->1<!-- -->)</li><li><a href="/tag/hardware">ハードウェア</a> <!-- -->(<!-- -->3<!-- -->)</li><li><a href="/tag/iot-device">IoTデバイス</a> <!-- -->(<!-- -->1<!-- -->)</li><li><a href="/tag/web-front">Webフロント</a> <!-- -->(<!-- -->2<!-- -->)</li><h3>固定ページ</h3><li><a href="/page/intro">自己紹介</a></li><h3>リンク</h3><li><a href="https://github.com/proactive-cybernetics/" target="_blank">github</a></li><li><a href="https://rclab.wp-x.jp/" target="_blank">旧ブログ</a></li><li><a href="https://twitter.com/wannabee1985" target="_blank">twitter</a></li></div><div id="index-btn"><span style="vertical-align:middle;width:100%"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="list" class="svg-inline--fa fa-list fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M80 368H16a16 16 0 0 0-16 16v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-64a16 16 0 0 0-16-16zm0-320H16A16 16 0 0 0 0 64v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16V64a16 16 0 0 0-16-16zm0 160H16a16 16 0 0 0-16 16v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-64a16 16 0 0 0-16-16zm416 176H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16z"></path></svg></span></div><div id="bottom-toc" style="visibility:hidden"><div class="toc"><p><strong>目次</strong></p><p style="font-size:0.9em"><a href="#hc77b57de51">あらまし</a></p><p style="font-size:0.9em"><a href="#hfb91fd38fa">I2C環境センサについて</a></p><p style="font-size:0.9em"><a href="#h3ea3cca820">Raspberry PiでI2Cを有効化する</a></p><p style="font-size:0.9em"><a href="#h9142ef6055">Raspberry Piにセンサを接続</a></p><p style="font-size:0.9em"><a href="#h0e869fb9b5">センサの動作確認</a></p><p style="font-size:0.9em"><a href="#h37245156f0">Discordボットの作成 : 自分専用サーバーの作成とボットの登録</a></p><p style="font-size:0.8em;padding-left:20px"><a href="#h830f7115b8">Discordサーバーにボットを招待する</a></p><p style="font-size:0.9em"><a href="#h22b6b12c88">DiscordボットのためのPythonの設定</a></p><p style="font-size:0.9em"><a href="#haddfa43deb">ボットの実装</a></p><p style="font-size:0.8em;padding-left:20px"><a href="#h40ea9a7213">一定時間ごとに定期投稿する</a></p><p style="font-size:0.9em"><a href="#ha214098e44">まとめ</a></p></div></div></main><footer><p style="color:silver">© <a href="https://proactive-cybernetics.netlify.app/page/intro">Oganesson</a> <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></p></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/article/202010-raspi-bot";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-1a2b070f4a4df673e7cc.js"],"app":["/app-d97328ac12a82a8c5235.js"],"component---src-pages-404-js":["/component---src-pages-404-js-1ef3fe603f871805736b.js"],"component---src-pages-page-2-js":["/component---src-pages-page-2-js-67f6a04db8d5184b6adb.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-af7a153d26b66650f280.js"],"component---src-templates-blog-article-js":["/component---src-templates-blog-article-js-9b1f8943374745c17eb9.js"],"component---src-templates-index-js":["/component---src-templates-index-js-60494b50eff8419740e3.js"],"component---src-templates-static-page-js":["/component---src-templates-static-page-js-35e640e9bacf3bd5f233.js"],"component---src-templates-tag-index-js":["/component---src-templates-tag-index-js-a622ecd1b2eedeba78a8.js"]};/*]]>*/</script><script src="/polyfill-1a2b070f4a4df673e7cc.js" nomodule=""></script><script src="/component---src-templates-blog-article-js-9b1f8943374745c17eb9.js" async=""></script><script src="/commons-21ff20e091921c8c0225.js" async=""></script><script src="/cb1608f2-f6f058bed42caceea208.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-d97328ac12a82a8c5235.js" async=""></script><script src="/framework-29ba174b433dc5858bed.js" async=""></script><script src="/webpack-runtime-ebe4b220d797aa410321.js" async=""></script></body></html>